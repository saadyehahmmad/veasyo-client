# Waiter PC Agent

A standalone Node.js bridge service that connects the Waiter cloud/web application to local network printers via TCP sockets.

## ðŸš€ Quick Start

**Option 1: Run interactively (recommended for testing)**
```bash
npm install
npm run build
npm start
```

**Option 2: Run in background (for production)**
```bash
npm install
npm run build
npm run start:bg     # Start in background
npm run status       # Check if running
npm run stop         # Stop the agent
```

**Option 3: Use the interactive CLI wizard:**
```bash
npm install
npm run cli
# Select option 1: Setup Wizard
```

The interactive CLI wizard will:
- âœ… Check prerequisites automatically
- âœ… Install dependencies
- âœ… Guide you through configuration step-by-step
- âœ… Build the application
- âœ… Test printer connection
- âœ… Install as Windows service (optional)
- âœ… Provide clear next steps

**Or use the CLI menu for management:**
- Configure settings
- Test printer connection
- Check status
- Install/uninstall service
- Start agent manually

## Architecture

```
Cloud/Web App (Backend) - Public IP: 194.195.87.213
     â†‘  Socket.IO (PC Agent connects automatically)
PC Agent (This Service) - Private IP: 192.168.x.x
     â†“  TCP Socket
LAN Printer (ESC/POS) - Private IP: 192.168.x.x
```

**Simple Setup:**
- PC Agent connects to backend automatically via Socket.IO
- **No port forwarding needed** - PC Agent initiates connection
- PC Agent and Printer must be on the same local network
- Just configure backend URL and tenant ID

## Features

- âœ… **Simple Background Mode**: Run as a background process without Windows service
- âœ… **Interactive CLI**: Complete setup and management tool
- âœ… **Automatic Connection**: Connects to backend via Socket.IO (no port forwarding)
- âœ… **Connection Pooling**: Efficient printer connection management
- âœ… **Auto-Start**: Runs as Windows service (optional)
- âœ… **Comprehensive Logging**: Detailed logs for troubleshooting
- âœ… **Real-time Communication**: Socket.IO for instant print jobs
- âœ… **Multiple Printers**: Support for multiple printers via configuration

## Installation

### Prerequisites

- Node.js 18+ installed ([Download Node.js](https://nodejs.org/))
- Windows 10+ (for service installation)
- Network access to your printer
- Backend server URL (where Waiter backend is running)
- Tenant ID from Waiter Admin Panel

### Setup

1. **Install dependencies:**
```bash
npm install
```

2. **Run interactive CLI:**
```bash
npm run cli
```

3. **Select option 1** for complete setup

The CLI will ask you for:
- **Backend URL**: Where your Waiter backend server is running
  - Local development: `http://localhost:3000`
  - Production: `http://your-server-ip:3000` or `https://your-domain.com`
- **Tenant ID**: Your restaurant's unique identifier (UUID from Admin Panel)
- **Printer IP**: Your thermal printer's IP address (e.g., `192.168.1.100`)
- **Printer Port**: Usually `9100` for network printers

The CLI will then:
- Check prerequisites
- Guide you through configuration
- Install dependencies
- Build the application
- Test printer connection
- Install as Windows service (optional)

## Interactive CLI

Run `npm run cli` to access the interactive management tool:

```
PC Agent - Interactive Setup & Management
============================================================

Select an option:
  1. Complete Setup (Recommended for first time)
  2. Configure Settings
  3. Test Printer Connection
  4. Install as Windows Service
  5. Uninstall Windows Service
  6. Check Status
  7. Start Agent Manually
  8. Exit
```

### CLI Options

**1. Complete Setup**
- Checks prerequisites
- Interactive configuration
- Installs dependencies
- Builds application
- Tests printer connection
- Optionally installs Windows service

**2. Configure Settings**
- Update configuration
- Modify printer settings
- Adjust advanced options

**3. Test Printer Connection**
- Tests TCP connection to configured printer
- Validates printer accessibility
- Provides troubleshooting tips

**4. Install as Windows Service**
- Installs PC Agent as Windows service
- Auto-starts on system boot
- Requires Administrator privileges

**5. Uninstall Windows Service**
- Removes Windows service
- Requires Administrator privileges

**6. Check Status**
- Shows current status
- Displays statistics
- Health information
- Connection pool status

**7. Start Agent Manually**
- Starts agent in foreground
- Useful for testing/debugging
- Press Ctrl+C to stop

## Configuration

**`.env` file is optional but recommended.** The agent will use defaults if `.env` doesn't exist, but you'll need to configure your printer IP.

Configuration is stored in `.env` file (auto-generated by CLI):

```env
# Server Configuration
BACKEND_URL=http://localhost:3000
TENANT_ID=your-tenant-id

# Printer Configuration (REQUIRED for printing)
PRINTER_IP=192.168.1.100
PRINTER_PORT=9100

# Connection Pool Settings
MAX_PRINTER_CONNECTIONS=5

# Logging Configuration
LOG_LEVEL=info
```

**Note:** 
- Use the interactive CLI (`npm run cli`) to configure settings
- **BACKEND_URL and TENANT_ID are required** - PC Agent connects to backend automatically
- Printer IP is optional - can be configured per-tenant in Admin Panel
- Manual editing of `.env` is also supported

## Communication

PC Agent communicates with the backend via **Socket.IO**:

- **Connection**: PC Agent connects to backend automatically (reverse connection)
- **Print Jobs**: Backend sends print jobs via Socket.IO events (`pc-agent:print-job`)
- **Status**: PC Agent sends health updates and print results back to backend
- **No HTTP API**: All communication is through Socket.IO for real-time performance

## Usage

### First Time Setup

```bash
npm install
npm run cli
# Select option 1: Complete Setup
```

### Running the Agent

**Option 1: Foreground (for testing/debugging)**
```bash
npm start
# Press Ctrl+C to stop
```

**Option 2: Background Process (recommended for production)**
```bash
# Start in background
npm run start:bg

# Check status
npm run status

# Stop the agent
npm run stop
```

**Option 3: Windows Service (auto-start on boot)**
```bash
# Install as service (requires Administrator)
npm run cli  # Select option 4
# Or use PowerShell script:
# .\install-service-admin.ps1

# Manage via Windows Services (services.msc)
```

### Daily Operations

```bash
# Check status
npm run status
# Or: npm run cli (Select option 6)

# View logs
cat logs/pc-agent.log

# Restart background process
npm run stop
npm run start:bg
```

### Service Management

```bash
# Install service (requires admin)
npm run cli  # Select option 4
# Or: .\install-service-admin.ps1

# Uninstall service (requires admin)
npm run cli  # Select option 5
# Or: .\uninstall-service-admin.ps1

# Check service in Windows
# Run: services.msc
# Look for "WaiterPCAgent"
```

## Troubleshooting

### PC Agent Won't Start

**Check status:**
```bash
npm run cli  # Select option 6
```

**Common issues:**
- Port already in use â†’ Change `PORT` in `.env`
- Node.js not found â†’ Install Node.js 18+
- Missing dependencies â†’ Run `npm install`

### Cannot Connect to Printer

**Test connection:**
```bash
npm run cli  # Select option 3
```

**Common issues:**
- Wrong printer IP â†’ Verify in printer settings
- Printer offline â†’ Check printer power/network
- Different networks â†’ Ensure PC and printer on same network
- Firewall blocking â†’ Check Windows Firewall

### Cannot Connect to Backend

**Verify configuration:**
```bash
npm run cli  # Select option 4
```

**Common issues:**
- PC Agent not running â†’ Start with `npm start` or install service
- Wrong BACKEND_URL â†’ Check backend URL is correct and accessible
- Wrong TENANT_ID â†’ Verify tenant ID matches your restaurant subdomain
- Network issues â†’ Check internet connection and firewall settings

## Troubleshooting

### Error: "ECONNREFUSED" when connecting to backend

**Symptoms:**
```
Error: websocket error
ECONNREFUSED ::1:3000 or 127.0.0.1:3000
```

**Causes and Solutions:**

1. **Backend server is not running**
   - Check if backend is running: `curl http://localhost:3000/health`
   - Start the backend server first before starting PC Agent

2. **Wrong BACKEND_URL configuration**
   - **Problem:** Using `http://localhost:3000` when backend is on a different server
   - **Solution:** Update `.env` with correct backend URL:
     ```env
     # If backend is on remote server:
     BACKEND_URL=http://194.195.87.213:3000
     
     # OR if using domain:
     BACKEND_URL=https://your-backend-domain.com
     ```

3. **Firewall blocking connection**
   - Check Windows Firewall
   - Ensure port 3000 is accessible
   - Test connection: `telnet backend-ip 3000`

### Error: "TENANT_ID is required"

Run the setup wizard to configure:
```bash
npm run cli
# Select option 1: Setup Wizard
```

### Error: "Printer connection failed"

1. Check printer is powered on
2. Verify printer IP address is correct
3. Ensure PC and printer are on same network
4. Test printer connection from CLI:
   ```bash
   npm run cli
   # Select option 3: Test Printer Connection
   ```

### PC Agent vs Backend Server Location

**Scenario 1: Both on same machine (Development)**
```env
BACKEND_URL=http://localhost:3000
```

**Scenario 2: Backend on remote server (Production)**
```env
# Backend at cloud server with IP 194.195.87.213
BACKEND_URL=http://194.195.87.213:3000

# OR backend at domain
BACKEND_URL=https://api.your-domain.com
```

**Key Point:** PC Agent initiates connection TO backend. Use the correct URL where YOUR backend is actually running!

## Logs

Logs are stored in `logs/` folder:
- `pc-agent.log` - All logs
- `error.log` - Errors only

**View logs:**
```bash
# Windows PowerShell
Get-Content logs/pc-agent.log -Tail 50 -Wait
```

## Development

```bash
# Development mode
npm run dev

# Build
npm run build

# Start
npm start
```

## Documentation

- [ARCHITECTURE.md](./ARCHITECTURE.md) - Architecture details
- [COMPATIBILITY.md](./COMPATIBILITY.md) - Compatibility guide

## Support

For help:
- Run `npm run cli` and use the interactive options
- Check logs in `logs/pc-agent.log`
- Review [ARCHITECTURE.md](./ARCHITECTURE.md) for technical details
