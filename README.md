# Waiter PC Agent

A standalone Node.js bridge service that connects the Waiter cloud/web application to local network printers via TCP sockets.

## ðŸš€ Quick Start

**Run the interactive CLI wizard:**
```bash
npm install
npm run cli
# Select option 1: Setup Wizard
```

The interactive CLI wizard will:
- âœ… Check prerequisites automatically
- âœ… Install dependencies
- âœ… Guide you through configuration step-by-step
- âœ… Build the application
- âœ… Test printer connection
- âœ… Install as Windows service (optional)
- âœ… Provide clear next steps

**Or use the CLI menu for management:**
- Configure settings
- Test printer connection
- Check status
- Install/uninstall service
- Start agent manually

## Architecture

```
Cloud/Web App (Backend) - Public IP: 194.195.87.213
     â†‘  Socket.IO (PC Agent connects automatically)
PC Agent (This Service) - Private IP: 192.168.x.x
     â†“  TCP Socket
LAN Printer (ESC/POS) - Private IP: 192.168.x.x
```

**Simple Setup:**
- PC Agent connects to backend automatically via Socket.IO
- **No port forwarding needed** - PC Agent initiates connection
- PC Agent and Printer must be on the same local network
- Just configure backend URL and tenant ID

## Features

- âœ… **Interactive CLI**: Complete setup and management tool
- âœ… **Automatic Connection**: Connects to backend via Socket.IO (no port forwarding)
- âœ… **Connection Pooling**: Efficient printer connection management
- âœ… **Auto-Start**: Runs as Windows service (optional)
- âœ… **Comprehensive Logging**: Detailed logs for troubleshooting
- âœ… **Real-time Communication**: Socket.IO for instant print jobs
- âœ… **Multiple Printers**: Support for multiple printers via configuration

## Installation

### Prerequisites

- Node.js 18+ installed ([Download Node.js](https://nodejs.org/))
- Windows 10+ (for service installation)
- Network access to your printer

### Setup

1. **Install dependencies:**
```bash
npm install
```

2. **Run interactive CLI:**
```bash
npm run cli
```

3. **Select option 1** for complete setup

The CLI will:
- Check prerequisites
- Guide you through configuration
- Install dependencies
- Build the application
- Test printer connection
- Install as Windows service (optional)

## Interactive CLI

Run `npm run cli` to access the interactive management tool:

```
PC Agent - Interactive Setup & Management
============================================================

Select an option:
  1. Complete Setup (Recommended for first time)
  2. Configure Settings
  3. Test Printer Connection
  4. Install as Windows Service
  5. Uninstall Windows Service
  6. Check Status
  7. Start Agent Manually
  8. Exit
```

### CLI Options

**1. Complete Setup**
- Checks prerequisites
- Interactive configuration
- Installs dependencies
- Builds application
- Tests printer connection
- Optionally installs Windows service

**2. Configure Settings**
- Update configuration
- Modify printer settings
- Adjust advanced options

**3. Test Printer Connection**
- Tests TCP connection to configured printer
- Validates printer accessibility
- Provides troubleshooting tips

**4. Install as Windows Service**
- Installs PC Agent as Windows service
- Auto-starts on system boot
- Requires Administrator privileges

**5. Uninstall Windows Service**
- Removes Windows service
- Requires Administrator privileges

**6. Check Status**
- Shows current status
- Displays statistics
- Health information
- Connection pool status

**7. Start Agent Manually**
- Starts agent in foreground
- Useful for testing/debugging
- Press Ctrl+C to stop

## Configuration

**`.env` file is optional but recommended.** The agent will use defaults if `.env` doesn't exist, but you'll need to configure your printer IP.

Configuration is stored in `.env` file (auto-generated by CLI):

```env
# Server Configuration
BACKEND_URL=http://localhost:3000
TENANT_ID=your-tenant-id

# Printer Configuration (REQUIRED for printing)
PRINTER_IP=192.168.1.100
PRINTER_PORT=9100

# Connection Pool Settings
MAX_PRINTER_CONNECTIONS=5

# Logging Configuration
LOG_LEVEL=info
```

**Note:** 
- Use the interactive CLI (`npm run cli`) to configure settings
- **BACKEND_URL and TENANT_ID are required** - PC Agent connects to backend automatically
- Printer IP is optional - can be configured per-tenant in Admin Panel
- Manual editing of `.env` is also supported

## Communication

PC Agent communicates with the backend via **Socket.IO**:

- **Connection**: PC Agent connects to backend automatically (reverse connection)
- **Print Jobs**: Backend sends print jobs via Socket.IO events (`pc-agent:print-job`)
- **Status**: PC Agent sends health updates and print results back to backend
- **No HTTP API**: All communication is through Socket.IO for real-time performance

## Usage

### First Time Setup

```bash
npm install
npm run cli
# Select option 1: Complete Setup
```

### Daily Operations

```bash
# Check status
npm run cli  # Select option 6

# Start manually (if not installed as service)
npm start
```

### Service Management

```bash
# Install service (requires admin)
npm run cli  # Select option 4

# Uninstall service (requires admin)
npm run cli  # Select option 5
```

## Troubleshooting

### PC Agent Won't Start

**Check status:**
```bash
npm run cli  # Select option 6
```

**Common issues:**
- Port already in use â†’ Change `PORT` in `.env`
- Node.js not found â†’ Install Node.js 18+
- Missing dependencies â†’ Run `npm install`

### Cannot Connect to Printer

**Test connection:**
```bash
npm run cli  # Select option 3
```

**Common issues:**
- Wrong printer IP â†’ Verify in printer settings
- Printer offline â†’ Check printer power/network
- Different networks â†’ Ensure PC and printer on same network
- Firewall blocking â†’ Check Windows Firewall

### Cannot Connect to Backend

**Verify configuration:**
```bash
npm run cli  # Select option 4
```

**Common issues:**
- PC Agent not running â†’ Start with `npm start` or install service
- Wrong BACKEND_URL â†’ Check backend URL is correct and accessible
- Wrong TENANT_ID â†’ Verify tenant ID matches your restaurant subdomain
- Network issues â†’ Check internet connection and firewall settings

## Logs

Logs are stored in `logs/` folder:
- `pc-agent.log` - All logs
- `error.log` - Errors only

**View logs:**
```bash
# Windows PowerShell
Get-Content logs/pc-agent.log -Tail 50 -Wait
```

## Development

```bash
# Development mode
npm run dev

# Build
npm run build

# Start
npm start
```

## Documentation

- [ARCHITECTURE.md](./ARCHITECTURE.md) - Architecture details
- [COMPATIBILITY.md](./COMPATIBILITY.md) - Compatibility guide

## Support

For help:
- Run `npm run cli` and use the interactive options
- Check logs in `logs/pc-agent.log`
- Review [ARCHITECTURE.md](./ARCHITECTURE.md) for technical details
